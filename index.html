<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decode Her Anger</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5e1e1;
        }

        .container {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .active {
            display: block;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
        }

        button {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #ff5252;
        }

        #conversationLog {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            height: 200px;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Role Selection -->
    <div id="roleSelection">
        <h2>Are you the...</h2>
        <button onclick="showGirlfriendSection()">Girlfriend ðŸ˜ </button>
        <button onclick="showBoyfriendSection()">Boyfriend ðŸ˜…</button>
    </div>

    <!-- Girlfriend Section -->
    <div id="girlfriendSection" class="container">
        <h2>Why Are You Mad?</h2>
        <textarea id="angerReason" placeholder="Enter the real reason you're angry..."></textarea>
        <input type="text" id="punishment" placeholder="Enter the punishment for failure">
        <button onclick="saveAnger()">Set Up Anger</button>
    </div>

    <!-- Boyfriend Section -->
    <div id="boyfriendSection" class="container">
        <div id="notMadMessage" class="hidden">
            <h3>Good news! She's not mad at you... for now ðŸ˜‡</h3>
        </div>
        
        <div id="gameInterface" class="hidden">
            <div id="conversationLog"></div>
            <div id="questionContainer">
                <p id="currentQuestion"></p>
                <input type="text" id="answerInput" placeholder="Your answer...">
                <button onclick="submitAnswer()">Submit</button>
            </div>
            <p>Questions remaining: <span id="questionCounter">11</span></p>
        </div>

        <div id="resultMessage" class="hidden"></div>
    </div>

    <script>
        const API_KEY = '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';
        let conversationLog = [];
        let currentQuestion = '';
        let questionCount = 11;

        function showGirlfriendSection() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('girlfriendSection').classList.add('active');
        }

        function showBoyfriendSection() {
            document.getElementById('roleSelection').style.display = 'none';
            const bfSection = document.getElementById('boyfriendSection');
            bfSection.classList.add('active');

            const angerReason = localStorage.getItem('angerReason');
            if (!angerReason) {
                document.getElementById('notMadMessage').classList.remove('hidden');
            } else {
                document.getElementById('gameInterface').classList.remove('hidden');
                conversationLog = JSON.parse(localStorage.getItem('conversationLog') || '[]');
                generateNewQuestion();
            }
        }

        async function generateNewQuestion(retry = false) {
            const previousQuestion = currentQuestion;
            
            try {
                const response = await fetch(
                    "https://api-inference.huggingface.co/models/distilgpt2",
                    {
                        headers: {
                            Authorization: `Bearer ${API_KEY}`,
                            "Content-Type": "application/json"
                        },
                        method: "POST",
                        body: JSON.stringify({
                            inputs: `Generate a question to help understand why she's angry. Context: ${localStorage.getItem('angerReason')}. Previous conversation: ${conversationLog.join('\n')}`,
                            parameters: {
                                temperature: 0.9,
                                max_new_tokens: 50
                            }
                        })
                    }
                );
                
                const result = await response.json();
                currentQuestion = result[0]?.generated_text || "What did I do wrong?";
                
                if (currentQuestion === previousQuestion && retry < 3) {
                    return generateNewQuestion(retry + 1);
                }

                document.getElementById('currentQuestion').textContent = currentQuestion;
                conversationLog.push(`AI: ${currentQuestion}`);
                updateConversationLog();
            } catch (error) {
                currentQuestion = "Can you give me a hint about what I did wrong?";
                document.getElementById('currentQuestion').textContent = currentQuestion;
            }
        }

        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value;
            conversationLog.push(`You: ${answer}`);
            updateConversationLog();

            const isOnPoint = await checkAnswer(answer);
            questionCount--;
            document.getElementById('questionCounter').textContent = questionCount;

            if (isOnPoint || questionCount <= 0) {
                endGame(isOnPoint);
            } else {
                document.getElementById('answerInput').value = '';
                generateNewQuestion();
            }
        }

        async function checkAnswer(answer) {
            try {
                const response = await fetch(
                    "https://api-inference.huggingface.co/models/distilgpt2",
                    {
                        headers: {
                            Authorization: `Bearer ${API_KEY}`,
                            "Content-Type": "application/json"
                        },
                        method: "POST",
                        body: JSON.stringify({
                            inputs: `Determine if this answer addresses the real reason (${localStorage.getItem('angerReason')}). Answer: ${answer}. Previous conversation: ${conversationLog.join('\n')}. Respond with JSON: { "onPoint": boolean }`,
                            parameters: {
                                temperature: 0.7
                            }
                        })
                    }
                );

                const result = await response.json();
                return result[0]?.generated_text?.includes('"onPoint": true') || false;
            } catch (error) {
                return false;
            }
        }

        function endGame(success) {
            document.getElementById('gameInterface').classList.add('hidden');
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.classList.remove('hidden');

            if (success) {
                resultDiv.innerHTML = `
                    <h3>ðŸŽ‰ Success! You decoded her anger! ðŸŽ‰</h3>
                    <p>Real reason: ${localStorage.getItem('angerReason')}</p>
                `;
            } else {
                resultDiv.innerHTML = `
                    <h3>ðŸ˜­ Game Over! ðŸ˜­</h3>
                    <p>Punishment: ${localStorage.getItem('punishment')}</p>
                    <p>Real reason was: ${localStorage.getItem('angerReason')}</p>
                `;
            }

            // Reset game state
            localStorage.removeItem('angerReason');
            localStorage.removeItem('punishment');
            localStorage.removeItem('conversationLog');
        }

        function saveAnger() {
            localStorage.setItem('angerReason', document.getElementById('angerReason').value);
            localStorage.setItem('punishment', document.getElementById('punishment').value);
            localStorage.setItem('conversationLog', JSON.stringify([]));
            alert('Anger parameters set! Now send him to the boyfriend section!');
        }

        function updateConversationLog() {
            const logDiv = document.getElementById('conversationLog');
            logDiv.innerHTML = conversationLog.join('<br>');
            logDiv.scrollTop = logDiv.scrollHeight;
            localStorage.setItem('conversationLog', JSON.stringify(conversationLog));
        }
    </script>
</body>
</html>
